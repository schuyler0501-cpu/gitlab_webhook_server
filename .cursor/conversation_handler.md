# 有效对话处理机制

## 🎯 核心功能

当用户在对话中使用 `[有效对话]` 标识时，AI 必须：

1. **识别标识**: 检测对话中是否包含 `[有效对话]`
2. **获取时间**: 获取当前北京时间（Asia/Shanghai 时区）
3. **保存对话**: 将用户消息和 AI 回复保存到 `.cursor/conversations.md`
4. **格式规范**: 使用统一的格式保存，包含时间戳

## 📝 保存格式

```markdown
## 对话记录 - 2024-01-15 14:30:25

### 用户
[有效对话] 我偏好使用中文注释，所有公开函数必须有中文注释

### AI 回复
好的，我会记住你的偏好。以后生成代码时，我会确保所有公开函数都有中文注释...

---
```

## 🔄 处理流程

### 1. 检测有效对话

在每次回复用户前，检查用户消息是否包含 `[有效对话]`：

```go
if strings.Contains(userMessage, "[有效对话]") {
    // 处理有效对话
}
```

### 2. 获取北京时间

使用系统时间，转换为北京时间（UTC+8）：

- **PowerShell**: `[System.TimeZoneInfo]::ConvertTimeBySystemTimeZoneId([DateTime]::Now, "China Standard Time")`
- **Bash**: `TZ='Asia/Shanghai' date`
- **Go**: 使用 `time.LoadLocation("Asia/Shanghai")`

### 3. 保存对话

将对话追加到 `.cursor/conversations.md` 文件：

- 包含时间戳
- 包含用户消息（去除 `[有效对话]` 标识）
- 包含 AI 回复
- 使用分隔线

### 4. 每次会话开始时回顾

在 `.cursorrules` 和 `.cursor/instructions.md` 中，AI 被要求：
- 每次对话开始时读取 `.cursor/conversations.md`
- 回顾历史有效对话
- 在生成回复时参考这些历史对话

## 💻 实现方式

### 方式 1: AI 自动处理（推荐）

AI 在回复时自动检测和处理：

```
用户: [有效对话] 我偏好使用中文注释

AI: 
1. 检测到 [有效对话] 标识
2. 获取当前北京时间
3. 生成回复
4. 将对话保存到 .cursor/conversations.md
5. 回复用户：✅ 已记录你的偏好...
```

### 方式 2: 使用脚本

如果 AI 无法直接写入文件，可以：
1. AI 生成保存命令
2. 用户执行脚本保存
3. 或 AI 提供保存内容，用户手动添加

## 📋 保存内容规范

### 必须包含
- ✅ 时间戳（北京时间）
- ✅ 用户消息（去除标识）
- ✅ AI 完整回复
- ✅ 清晰的格式和分隔

### 可选包含
- 对话主题标签
- 关键词提取
- 关联的代码文件

## 🔍 历史对话回顾

### 在每次对话开始时

AI 应该：

1. **读取历史文件**: 打开 `.cursor/conversations.md`
2. **快速浏览**: 了解历史对话主题
3. **提取关键信息**: 识别用户的偏好和要求
4. **应用到当前对话**: 在回复时参考历史对话

### 回顾重点

- 用户的代码风格偏好
- 项目特定要求
- 开发习惯
- 常用模式
- 禁止事项

## 🛠️ 维护建议

### 定期清理

- 每月审查一次历史对话
- 将重要内容提取到 `.cursor/memory.md`
- 删除过时的对话记录

### 文件大小管理

- 如果文件过大（>100KB），考虑：
  - 归档旧对话到 `.cursor/conversations_archive.md`
  - 只保留最近 3 个月的对话

### 备份

- 历史对话文件应该提交到 Git
- 定期备份重要对话

## 📊 统计和分析

可以添加统计功能：

- 对话总数
- 最近对话时间
- 最常讨论的主题
- 用户偏好变化趋势

---

**重要**: 这个机制确保 AI 能够建立长久持续的记忆，记住用户的重要偏好和要求。

