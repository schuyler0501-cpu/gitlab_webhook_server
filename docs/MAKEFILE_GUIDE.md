# Makefile ä½¿ç”¨æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»é¡¹ç›® Makefile çš„ä½¿ç”¨æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚

## ğŸ“‹ ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [å‘½ä»¤è¯¦è§£](#å‘½ä»¤è¯¦è§£)
3. [å¼€å‘å·¥ä½œæµ](#å¼€å‘å·¥ä½œæµ)
4. [è·¨å¹³å°æ”¯æŒ](#è·¨å¹³å°æ”¯æŒ)
5. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
6. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## å¿«é€Ÿå¼€å§‹

### é¦–æ¬¡ä½¿ç”¨

```bash
# 1. æ£€æŸ¥å¼€å‘ç¯å¢ƒ
make check-env

# 2. å®‰è£…å¼€å‘å·¥å…·ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
make install-tools

# 3. å®‰è£…é¡¹ç›®ä¾èµ–
make deps

# 4. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
make dev
```

### æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤

```bash
make help
```

---

## å‘½ä»¤è¯¦è§£

### ğŸ—ï¸ æ„å»ºå’Œè¿è¡Œ

#### `make build`

æ„å»ºåº”ç”¨ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚

```bash
make build
```

**åŠŸèƒ½**ï¼š
- åˆ›å»º `bin/` ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- ç¼–è¯‘ Go ä»£ç ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
- ä½¿ç”¨ `-ldflags="-s -w"` ä¼˜åŒ–äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°
- Windows ç³»ç»Ÿè‡ªåŠ¨æ·»åŠ  `.exe` æ‰©å±•å

**è¾“å‡º**ï¼š
- `bin/gitlab-webhook-server` (Linux/Mac)
- `bin/gitlab-webhook-server.exe` (Windows)

#### `make run`

æ„å»ºå¹¶è¿è¡Œåº”ç”¨ã€‚

```bash
make run
```

**åŠŸèƒ½**ï¼š
- å…ˆæ‰§è¡Œ `make build`
- ç„¶åè¿è¡Œç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰æµ‹è¯•
- éªŒè¯æ„å»ºæ˜¯å¦æˆåŠŸ

#### `make dev`

å¯åŠ¨å¼€å‘æ¨¡å¼ï¼Œæ”¯æŒçƒ­é‡è½½ã€‚

```bash
make dev
```

**åŠŸèƒ½**ï¼š
- å¦‚æœå®‰è£…äº† Airï¼Œä½¿ç”¨ Air è¿›è¡Œçƒ­é‡è½½
- å¦‚æœæœªå®‰è£… Airï¼Œä½¿ç”¨æ™®é€šæ¨¡å¼è¿è¡Œï¼ˆ`go run`ï¼‰

**çƒ­é‡è½½ä¼˜åŠ¿**ï¼š
- ä»£ç ä¿®æ”¹åè‡ªåŠ¨é‡æ–°ç¼–è¯‘å’Œè¿è¡Œ
- æé«˜å¼€å‘æ•ˆç‡
- å®æ—¶æŸ¥çœ‹ä»£ç å˜æ›´æ•ˆæœ

**å®‰è£… Air**ï¼š
```bash
make install-tools
# æˆ–
go install github.com/air-verse/air@latest
```

---

### ğŸ§ª æµ‹è¯•å’Œæ£€æŸ¥

#### `make test`

è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šã€‚

```bash
make test
```

**åŠŸèƒ½**ï¼š
- è¿è¡Œé¡¹ç›®ä¸­çš„æ‰€æœ‰æµ‹è¯•
- ä½¿ç”¨ `-race` æ ‡å¿—æ£€æµ‹ç«æ€æ¡ä»¶
- ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šï¼š`coverage.out` å’Œ `coverage.html`

**è¾“å‡ºæ–‡ä»¶**ï¼š
- `coverage.out` - æ–‡æœ¬æ ¼å¼è¦†ç›–ç‡æŠ¥å‘Š
- `coverage.html` - HTML æ ¼å¼è¦†ç›–ç‡æŠ¥å‘Šï¼ˆå¯åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹ï¼‰

**æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š**ï¼š
```bash
# æ‰“å¼€ HTML æŠ¥å‘Š
open coverage.html  # Mac
start coverage.html  # Windows
xdg-open coverage.html  # Linux
```

#### `make lint`

è¿è¡Œä»£ç æ£€æŸ¥å·¥å…·ã€‚

```bash
make lint
```

**åŠŸèƒ½**ï¼š
- ä½¿ç”¨ `golangci-lint` æ£€æŸ¥ä»£ç è´¨é‡
- æ£€æµ‹æ½œåœ¨é—®é¢˜ã€ä»£ç é£æ ¼é—®é¢˜ç­‰

**è¦æ±‚**ï¼š
- éœ€è¦å®‰è£… `golangci-lint`
- å®‰è£…å‘½ä»¤ï¼š`make install-tools`

**å¸¸è§é—®é¢˜ä¿®å¤**ï¼š
- æ ¹æ® lint è¾“å‡ºä¿®å¤é—®é¢˜
- æŸäº›é—®é¢˜å¯ä»¥ä½¿ç”¨ `make fmt` è‡ªåŠ¨ä¿®å¤

#### `make fmt`

æ ¼å¼åŒ–ä»£ç ã€‚

```bash
make fmt
```

**åŠŸèƒ½**ï¼š
- ä½¿ç”¨ `go fmt` æ ¼å¼åŒ–ä»£ç 
- ä½¿ç”¨ `goimports` æ•´ç†å¯¼å…¥è¯­å¥

**è¦æ±‚**ï¼š
- éœ€è¦å®‰è£… `goimports`ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
- å®‰è£…å‘½ä»¤ï¼š`make install-tools`

**å»ºè®®**ï¼š
- æäº¤ä»£ç å‰è¿è¡Œ `make fmt`
- é…ç½® IDE è‡ªåŠ¨æ ¼å¼åŒ–ï¼ˆä¿å­˜æ—¶ï¼‰

---

### ğŸ› ï¸ å·¥å…·å’Œä¾èµ–

#### `make deps`

å®‰è£…å’Œæ›´æ–°é¡¹ç›®ä¾èµ–ã€‚

```bash
make deps
```

**åŠŸèƒ½**ï¼š
- ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…
- æ•´ç† `go.mod` å’Œ `go.sum` æ–‡ä»¶
- ç§»é™¤æœªä½¿ç”¨çš„ä¾èµ–

**ä½¿ç”¨åœºæ™¯**ï¼š
- é¦–æ¬¡å…‹éš†é¡¹ç›®å
- æ›´æ–°ä¾èµ–å
- æ·»åŠ æ–°ä¾èµ–å

#### `make install-tools`

å®‰è£…å¼€å‘å·¥å…·ã€‚

```bash
make install-tools
```

**å®‰è£…çš„å·¥å…·**ï¼š
1. **Air** - çƒ­é‡è½½å·¥å…·
   - å®‰è£…è·¯å¾„ï¼š`github.com/air-verse/air@latest`
2. **golangci-lint** - ä»£ç æ£€æŸ¥å·¥å…·
   - å®‰è£…è·¯å¾„ï¼š`github.com/golangci/golangci-lint/cmd/golangci-lint@latest`
3. **goimports** - å¯¼å…¥ç®¡ç†å·¥å…·
   - å®‰è£…è·¯å¾„ï¼š`golang.org/x/tools/cmd/goimports@latest`

**å®‰è£…ä½ç½®**ï¼š
- `$GOPATH/bin` æˆ– `$HOME/go/bin`

**é‡è¦æç¤º**ï¼š
- ç¡®ä¿å·¥å…·è·¯å¾„åœ¨ `PATH` ç¯å¢ƒå˜é‡ä¸­
- Windows ç”¨æˆ·éœ€è¦å°† `%GOPATH%\bin` æ·»åŠ åˆ° PATH
- Linux/Mac ç”¨æˆ·éœ€è¦å°† `$GOPATH/bin` æ·»åŠ åˆ° PATH

#### `make check-env`

æ£€æŸ¥å¼€å‘ç¯å¢ƒé…ç½®ã€‚

```bash
make check-env
```

**æ£€æŸ¥é¡¹**ï¼š
- æ“ä½œç³»ç»Ÿç±»å‹
- Go ç‰ˆæœ¬
- Go è·¯å¾„é…ç½®
- å¼€å‘å·¥å…·å®‰è£…çŠ¶æ€ï¼ˆAir, golangci-lint, goimportsï¼‰
- é¡¹ç›®é…ç½®æ–‡ä»¶ï¼ˆ.env, go.modï¼‰

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸ” æ£€æŸ¥å¼€å‘ç¯å¢ƒ...
æ“ä½œç³»ç»Ÿ: Windows
Go ç‰ˆæœ¬: go version go1.21.5 windows/amd64
Go è·¯å¾„: C:\Users\user\go

å·¥å…·æ£€æŸ¥:
  Air: âœ… å·²å®‰è£…
  golangci-lint: âŒ æœªå®‰è£… (è¿è¡Œ: make install-tools)
  goimports: âœ… å·²å®‰è£…

é¡¹ç›®æ£€æŸ¥:
  .env æ–‡ä»¶: âœ… å­˜åœ¨
  go.mod: âœ… å­˜åœ¨
```

---

### ğŸ§¹ æ¸…ç†

#### `make clean`

æ¸…ç†æ„å»ºæ–‡ä»¶å’Œç¼“å­˜ã€‚

```bash
make clean
```

**æ¸…ç†å†…å®¹**ï¼š
- `bin/` ç›®å½•ï¼ˆæ„å»ºè¾“å‡ºï¼‰
- `coverage.out`ï¼ˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šï¼‰
- `coverage.html`ï¼ˆHTML è¦†ç›–ç‡æŠ¥å‘Šï¼‰
- Go æ„å»ºç¼“å­˜

**ä½¿ç”¨åœºæ™¯**ï¼š
- è§£å†³æ„å»ºé—®é¢˜
- æ¸…ç†ç£ç›˜ç©ºé—´
- å‡†å¤‡å…¨æ–°æ„å»º

---

### â„¹ï¸ ä¿¡æ¯

#### `make version`

æ˜¾ç¤ºé¡¹ç›®ç‰ˆæœ¬ä¿¡æ¯ã€‚

```bash
make version
```

**æ˜¾ç¤ºä¿¡æ¯**ï¼š
- é¡¹ç›®åç§°
- Go ç‰ˆæœ¬
- æ“ä½œç³»ç»Ÿ
- æ¨¡å—è·¯å¾„
- Go ç‰ˆæœ¬è¦æ±‚

#### `make help`

æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨å‘½ä»¤å’Œå¸®åŠ©ä¿¡æ¯ã€‚

```bash
make help
```

---

## å¼€å‘å·¥ä½œæµ

### æ—¥å¸¸å¼€å‘æµç¨‹

```bash
# 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆçƒ­é‡è½½ï¼‰
make dev

# 2. ä¿®æ”¹ä»£ç åï¼ŒAir ä¼šè‡ªåŠ¨é‡æ–°ç¼–è¯‘å’Œè¿è¡Œ

# 3. æäº¤ä»£ç å‰
make fmt      # æ ¼å¼åŒ–ä»£ç 
make lint     # ä»£ç æ£€æŸ¥
make test     # è¿è¡Œæµ‹è¯•
```

### æ–°åŠŸèƒ½å¼€å‘æµç¨‹

```bash
# 1. åˆ›å»ºæ–°åˆ†æ”¯
git checkout -b feature/new-feature

# 2. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
make deps

# 3. å¼€å‘åŠŸèƒ½
make dev

# 4. æµ‹è¯•å’Œæ£€æŸ¥
make test
make lint
make fmt

# 5. æäº¤ä»£ç 
git add .
git commit -m "feat: æ·»åŠ æ–°åŠŸèƒ½"
```

### å‡†å¤‡å‘å¸ƒæµç¨‹

```bash
# 1. ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
make test

# 2. ä»£ç æ£€æŸ¥
make lint

# 3. æ¸…ç†æ—§æ„å»º
make clean

# 4. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
make build

# 5. æµ‹è¯•æ„å»ºäº§ç‰©
make run
```

---

## è·¨å¹³å°æ”¯æŒ

### æ”¯æŒçš„æ“ä½œç³»ç»Ÿ

- âœ… **Windows** (Windows_NT)
- âœ… **Linux** (å„ç§å‘è¡Œç‰ˆ)
- âœ… **macOS** (Darwin)

### è‡ªåŠ¨æ£€æµ‹

Makefile ä¼šè‡ªåŠ¨æ£€æµ‹æ“ä½œç³»ç»Ÿå¹¶è°ƒæ•´å‘½ä»¤ï¼š

- **æ–‡ä»¶è·¯å¾„**ï¼šWindows ä½¿ç”¨åæ–œæ ï¼ŒUnix ä½¿ç”¨æ­£æ–œæ 
- **å¯æ‰§è¡Œæ–‡ä»¶**ï¼šWindows è‡ªåŠ¨æ·»åŠ  `.exe` æ‰©å±•å
- **å‘½ä»¤æ£€æµ‹**ï¼šWindows ä½¿ç”¨ `where`ï¼ŒUnix ä½¿ç”¨ `command -v`
- **æ–‡ä»¶åˆ é™¤**ï¼šWindows ä½¿ç”¨ PowerShellï¼ŒUnix ä½¿ç”¨ `rm`

### Windows ç”¨æˆ·æ³¨æ„äº‹é¡¹

1. **å®‰è£… Make å·¥å…·**ï¼š
   - ä½¿ç”¨ Git Bashï¼ˆæ¨èï¼‰
   - æˆ–å®‰è£… Chocolateyï¼š`choco install make`
   - æˆ–ä½¿ç”¨ WSL (Windows Subsystem for Linux)

2. **PATH é…ç½®**ï¼š
   - ç¡®ä¿ `%GOPATH%\bin` åœ¨ PATH ä¸­
   - æˆ– `%USERPROFILE%\go\bin`

3. **PowerShell æ‰§è¡Œç­–ç•¥**ï¼š
   - å¦‚æœé‡åˆ° PowerShell æ‰§è¡Œç­–ç•¥é—®é¢˜ï¼Œè¿è¡Œï¼š
   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
   ```

---

## å¸¸è§é—®é¢˜

### Q1: `make: command not found`

**é—®é¢˜**ï¼šç³»ç»Ÿæœªå®‰è£… Make å·¥å…·ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **Windows**: å®‰è£… Git Bash æˆ–ä½¿ç”¨ Chocolatey å®‰è£… Make
- **Linux**: `sudo apt-get install make` (Debian/Ubuntu) æˆ– `sudo yum install make` (CentOS/RHEL)
- **macOS**: é€šå¸¸å·²é¢„è£…ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå®‰è£… Xcode Command Line Tools

### Q2: `air: command not found`

**é—®é¢˜**ï¼šAir æœªå®‰è£…æˆ–ä¸åœ¨ PATH ä¸­ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å®‰è£… Air
make install-tools

# æˆ–æ‰‹åŠ¨å®‰è£…
go install github.com/air-verse/air@latest

# æ£€æŸ¥ PATH
echo $PATH  # Linux/Mac
echo %PATH%  # Windows

# æ·»åŠ  Go bin åˆ° PATH
# Linux/Mac: æ·»åŠ åˆ° ~/.bashrc æˆ– ~/.zshrc
export PATH=$PATH:$(go env GOPATH)/bin

# Windows: æ·»åŠ åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡
# è·¯å¾„: %USERPROFILE%\go\bin
```

### Q3: `golangci-lint: command not found`

**é—®é¢˜**ï¼šgolangci-lint æœªå®‰è£…ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
make install-tools
```

### Q4: Windows ä¸Š `rm` å‘½ä»¤å¤±è´¥

**é—®é¢˜**ï¼šMakefile ä½¿ç”¨äº† Unix å‘½ä»¤ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ Git Bash è¿è¡Œ Make å‘½ä»¤
- æˆ–ä½¿ç”¨ WSL
- Makefile å·²ä¼˜åŒ–ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ PowerShell å‘½ä»¤

### Q5: æ„å»ºå¤±è´¥ï¼š`cannot find package`

**é—®é¢˜**ï¼šä¾èµ–æœªå®‰è£…æˆ– `go.mod` æœ‰é—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# é‡æ–°å®‰è£…ä¾èµ–
make deps

# æˆ–æ‰‹åŠ¨æ‰§è¡Œ
go mod download
go mod tidy
```

### Q6: æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šæœªç”Ÿæˆ

**é—®é¢˜**ï¼šå¯èƒ½æ²¡æœ‰æµ‹è¯•æ–‡ä»¶æˆ–æµ‹è¯•å¤±è´¥ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥æ˜¯å¦æœ‰æµ‹è¯•æ–‡ä»¶
find . -name "*_test.go"

# å•ç‹¬è¿è¡Œæµ‹è¯•æŸ¥çœ‹é”™è¯¯
go test -v ./...
```

---

## æœ€ä½³å®è·µ

### 1. é¦–æ¬¡è®¾ç½®

```bash
# å®Œæ•´çš„é¦–æ¬¡è®¾ç½®æµç¨‹
make check-env          # æ£€æŸ¥ç¯å¢ƒ
make install-tools      # å®‰è£…å·¥å…·
make deps               # å®‰è£…ä¾èµ–
cp env.example .env     # é…ç½®ç¯å¢ƒå˜é‡
make dev                # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```

### 2. ä»£ç æäº¤å‰

```bash
# æäº¤å‰çš„æ£€æŸ¥æ¸…å•
make fmt                # æ ¼å¼åŒ–ä»£ç 
make lint               # ä»£ç æ£€æŸ¥
make test               # è¿è¡Œæµ‹è¯•
make clean              # æ¸…ç†æ„å»ºæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
```

### 3. å®šæœŸç»´æŠ¤

```bash
# å®šæœŸæ›´æ–°ä¾èµ–å’Œå·¥å…·
make deps               # æ›´æ–°é¡¹ç›®ä¾èµ–
make install-tools      # æ›´æ–°å¼€å‘å·¥å…·ï¼ˆéœ€è¦æ‰‹åŠ¨è¿è¡Œ go installï¼‰
```

### 4. æ€§èƒ½ä¼˜åŒ–

```bash
# æ„å»ºä¼˜åŒ–ç‰ˆæœ¬
make clean              # æ¸…ç†æ—§æ„å»º
make build              # é‡æ–°æ„å»ºï¼ˆå·²åŒ…å« -ldflags="-s -w"ï¼‰
```

### 5. è°ƒè¯•æŠ€å·§

```bash
# æ£€æŸ¥ç¯å¢ƒé…ç½®
make check-env

# æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
make version

# æ¸…ç†åé‡æ–°æ„å»º
make clean && make build
```

---

## æ‰©å±• Makefile

å¦‚æœéœ€è¦æ·»åŠ æ–°çš„å‘½ä»¤ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹æ¨¡å¼ï¼š

```makefile
# æ–°å‘½ä»¤ç¤ºä¾‹
.PHONY: new-command

new-command:
	@echo "æ‰§è¡Œæ–°å‘½ä»¤..."
	@# ä½ çš„å‘½ä»¤ here
	@echo "âœ… å®Œæˆ"
```

**æ·»åŠ åˆ° help**ï¼š
```makefile
help:
	@echo "    make new-command - æ–°å‘½ä»¤æè¿°"
```

---

## ç›¸å…³æ–‡æ¡£

- [å¼€å‘è§„èŒƒ](./DEVELOPMENT.md) - è¯¦ç»†çš„å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µ
- [å¿«é€Ÿå¼€å§‹](../QUICKSTART.md) - é¡¹ç›®å¿«é€Ÿä¸Šæ‰‹æŒ‡å—
- [è‡ªæµ‹æŒ‡å—](./SELF_TEST_GUIDE.md) - åŠŸèƒ½æµ‹è¯•æŒ‡å—

---

**æç¤º**ï¼šé‡åˆ°é—®é¢˜æ—¶ï¼Œå…ˆè¿è¡Œ `make check-env` æ£€æŸ¥ç¯å¢ƒé…ç½®ï¼Œç„¶åæŸ¥çœ‹æœ¬æ–‡æ¡£çš„å¸¸è§é—®é¢˜éƒ¨åˆ†ã€‚
